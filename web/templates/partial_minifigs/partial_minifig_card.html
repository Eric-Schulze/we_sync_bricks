{{ define "partial_minifig_card" }}
<div class="list-item p-6 border border-gray-200 rounded-xl bg-white mb-4 shadow-sm">
    <div class="flex gap-6">
        <!-- Minifig Picture -->
        <div class="flex-none w-30">
            <div id="minifig-picture-{{.ID}}" class="w-30 h-30 bg-gray-50 border border-gray-200 rounded-lg flex items-center justify-center relative">
                {{if .BricklinkID}}
                    <div class="text-3xl text-gray-400">üì∑</div>
                    <div class="absolute bottom-1 right-1 bg-black bg-opacity-70 text-white px-1 py-0.5 rounded text-xs">
                        {{.BricklinkID}}
                    </div>
                {{else}}
                    <div class="text-center text-gray-400">
                        <div class="text-2xl">üì¶</div>
                        <div class="text-xs">No ID</div>
                    </div>
                {{end}}
            </div>
        </div>
        
        <!-- Minifig Information -->
        <div class="flex-1 flex flex-col">
            <!-- Header with Item Name and Actions -->
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="m-0 text-gray-700 text-lg font-semibold">
                        {{if .ItemName}}{{.ItemName}}{{else if .BricklinkID}}{{.BricklinkID}}{{else}}Unknown Minifig{{end}}
                    </h3>
                    {{if .ReferenceID}}
                        <div class="text-sm text-gray-500 mt-1">
                            üóÉÔ∏è {{.ReferenceID}}
                        </div>
                    {{end}}
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-secondary py-1 px-2 text-xs"
                            hx-get="/partial-minifigs-lists/{{.PartialMinifigListID}}/partial-minifig/{{.ID}}/edit" 
                            hx-target="#modal-container" 
                            hx-swap="innerHTML">
                        Edit
                    </button>
                    <button class="btn bg-red-600 py-1 px-2 text-xs"
                            hx-delete="/partial-minifigs-lists/{{.PartialMinifigListID}}/partial-minifig/{{.ID}}" 
                            hx-target="#list-items" 
                            hx-swap="outerHTML"
                            hx-confirm="Are you sure you want to delete this item?">
                        Delete
                    </button>
                </div>
            </div>
            
            <!-- Details Grid -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <!-- Condition -->
                <div>
                    <div class="text-xs text-gray-500 font-medium mb-1">
                        CONDITION
                    </div>
                    <div class="text-sm text-gray-700">
                        {{if .Condition}}
                            {{if eq .Condition "N"}}
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">New</span>
                            {{else if eq .Condition "U"}}
                                <span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs">Used</span>
                            {{else}}
                                {{.Condition}}
                            {{end}}
                        {{else}}
                            <span class="text-gray-400">Not specified</span>
                        {{end}}
                    </div>
                </div>
                
                <!-- Created Date -->
                <div>
                    <div class="text-xs text-gray-500 font-medium mb-1">
                        ADDED
                    </div>
                    <div class="text-sm text-gray-700">
                        {{.CreatedAt.Format "Jan 2, 2006"}}
                    </div>
                </div>
            </div>
            
            <!-- Notes -->
            {{if .Notes}}
                <div class="mb-4">
                    <div class="text-xs text-gray-500 font-medium mb-1">
                        NOTES
                    </div>
                    <div class="text-sm text-gray-700 bg-gray-50 p-3 rounded-md border-l-4 border-blue-500">
                        {{.Notes}}
                    </div>
                </div>
            {{end}}
            
            <!-- Parts Summary -->
            <div class="mt-auto">
                <div class="text-xs text-gray-500 font-medium mb-1">
                    PARTS PROGRESS
                </div>
                <div class="flex items-center gap-3">
                    {{if .Parts}}
                        {{$totalParts := 0}}
                        {{$totalNeeded := 0}}
                        {{$totalCollected := 0}}
                        {{range .Parts}}
                            {{$totalParts = plus $totalParts 1}}
                            {{$totalNeeded = plus $totalNeeded .QuantityNeeded}}
                            {{$totalCollected = plus $totalCollected .QuantityCollected}}
                        {{end}}
                        {{$percentage := 0}}
                        {{if gt $totalNeeded 0}}
                            {{$percentage = div (mul $totalCollected 100) $totalNeeded}}
                        {{end}}
                        
                        <div class="flex flex-col gap-1">
                            <div class="text-sm text-gray-700 font-medium">
                                {{$totalCollected}}/{{$totalNeeded}} pieces ({{$percentage}}%)
                            </div>
                            <div class="text-xs text-gray-500">
                                {{$totalParts}} unique parts
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="flex-1 max-w-25">
                            <div class="bg-gray-200 h-2 rounded overflow-hidden">
                                <div class="h-full transition-all duration-300 {{if eq $percentage 100}}bg-green-500{{else}}bg-blue-500{{end}}" style="width: {{$percentage}}%;"></div>
                            </div>
                        </div>
                        
                        <button class="bg-gray-100 border border-gray-300 py-1 px-2 rounded text-xs text-gray-500 cursor-pointer"
                                onclick="togglePartsForMinifig({{.ID}})">
                            <span id="parts-toggle-{{.ID}}">Show Parts</span>
                        </button>
                    {{else}}
                        <div class="text-sm text-gray-400">
                            Parts not loaded
                        </div>
                    {{end}}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Expandable Parts List -->
    {{if .Parts}}
        <div id="parts-list-{{.ID}}" class="hidden mt-4 pt-4 border-t border-gray-200">
            <div class="text-sm font-medium text-gray-700 mb-3">
                Required Parts ({{len .Parts}})
            </div>
            <div class="grid grid-cols-[repeat(auto-fill,minmax(250px,1fr))] gap-3">
                {{range .Parts}}
                    <div class="bg-gray-50 p-3 rounded-md border border-gray-200 {{if eq .QuantityCollected .QuantityNeeded}}border-green-500{{end}}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="text-xs font-medium text-gray-700">
                                {{if .PartName}}{{.PartName}}{{else if .BricklinkID}}{{.BricklinkID}}{{else}}Part {{.ItemID}}{{end}}
                            </div>
                            <div class="text-xs text-gray-700 font-semibold">
                                {{.QuantityCollected}}/{{.QuantityNeeded}}
                            </div>
                        </div>
                        
                        <div class="text-xs text-gray-500 mb-2">
                            {{if .BricklinkID}}ID: {{.BricklinkID}}{{else}}Item: {{.ItemID}}{{end}}
                            {{if .ColorID}} | Color: {{.ColorID}}{{end}}
                            {{if .Condition}} | {{if eq .Condition "N"}}New{{else if eq .Condition "U"}}Used{{else}}{{.Condition}}{{end}}{{end}}
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <!-- Progress for this part -->
                            <div class="flex-1 mr-2">
                                {{$partPercentage := 0}}
                                {{if gt .QuantityNeeded 0}}
                                    {{$partPercentage = div (mul .QuantityCollected 100) .QuantityNeeded}}
                                {{end}}
                                <div class="bg-gray-200 h-1.5 rounded-sm overflow-hidden">
                                    <div class="h-full transition-all duration-300 {{if eq .QuantityCollected .QuantityNeeded}}bg-green-500{{else}}bg-blue-500{{end}}" style="width: {{$partPercentage}}%;"></div>
                                </div>
                            </div>
                            
                            {{if eq .QuantityCollected .QuantityNeeded}}
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">‚úì Complete</span>
                            {{else}}
                                <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs">{{$partPercentage}}%</span>
                            {{end}}
                        </div>
                    </div>
                {{end}}
            </div>
        </div>
    {{end}}
</div>

{{if .BricklinkID}}
<script>
// Auto-load minifig picture when card is rendered
(function() {
    const minifigId = '{{.BricklinkID}}';
    const cardId = '{{.ID}}';
    
    console.log('Initializing picture loading for:', {minifigId, cardId});
    
    if (minifigId && cardId) {
        // Use a small delay to ensure DOM is ready
        setTimeout(function() {
            loadMinifigPictureForCard(minifigId, cardId);
        }, 100);
    }
})();

function loadMinifigPictureForCard(minifigId, cardId) {
    console.log('Loading picture for card:', cardId, 'minifig:', minifigId);
    
    const pictureContainer = document.getElementById('minifig-picture-' + cardId);
    if (!pictureContainer) {
        console.error('Picture container not found for card:', cardId);
        return;
    }
    
    fetch('/partial-minifigs-lists/minifig-picture', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'bricklink_id=' + encodeURIComponent(minifigId)
    })
    .then(response => {
        console.log('Picture API response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Picture API response for card:', data);
        
        if (data && data.meta && data.meta.code === 200 && data.data) {
            const firstImage = data.data;
            const imageUrl = firstImage.thumbnail_url || firstImage.url;
            if (imageUrl) {
                pictureContainer.innerHTML = '<img src="' + imageUrl + '" alt="Minifig ' + minifigId + '" class="max-w-full max-h-full object-contain rounded-lg"><div class="absolute bottom-1 right-1 bg-black bg-opacity-70 text-white px-1 py-0.5 rounded text-xs">' + minifigId + '</div>';
                pictureContainer.className = pictureContainer.className.replace('flex items-center justify-center relative', '') + ' flex items-center justify-center relative';
            }
        } else {
            console.log('Picture API failed for card:', cardId, data && data.meta ? data.meta.message : 'Unknown error');
        }
    })
    .catch(error => {
        console.error('Error loading picture for card:', cardId, error);
    });
}

function togglePartsForMinifig(minifigId) {
    const partsList = document.getElementById('parts-list-' + minifigId);
    const toggleText = document.getElementById('parts-toggle-' + minifigId);
    
    if (partsList.style.display === 'none') {
        partsList.style.display = 'block';
        toggleText.textContent = 'Hide Parts';
    } else {
        partsList.style.display = 'none';
        toggleText.textContent = 'Show Parts';
    }
}
</script>
{{end}}
{{ end }}