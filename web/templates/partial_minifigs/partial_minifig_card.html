{{ define "partial_minifig_card" }}
<div class="list-item" style="padding: 1.5rem; border: 1px solid #e5e7eb; border-radius: 12px; background-color: white; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
    <div style="display: flex; gap: 1.5rem;">
        <!-- Minifig Picture -->
        <div style="flex: 0 0 120px;">
            <div id="minifig-picture-{{.ID}}" style="width: 120px; height: 120px; background-color: #f8f9fa; border: 1px solid #e5e7eb; border-radius: 8px; display: flex; align-items: center; justify-content: center; position: relative;">
                {{if .BricklinkID}}
                    <div style="font-size: 2rem; color: #9ca3af;">üì∑</div>
                    <div style="position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.7); color: white; padding: 2px 4px; border-radius: 4px; font-size: 0.6rem;">
                        {{.BricklinkID}}
                    </div>
                {{else}}
                    <div style="text-align: center; color: #9ca3af;">
                        <div style="font-size: 1.5rem;">üì¶</div>
                        <div style="font-size: 0.7rem;">No ID</div>
                    </div>
                {{end}}
            </div>
        </div>
        
        <!-- Minifig Information -->
        <div style="flex: 1; display: flex; flex-direction: column;">
            <!-- Header with Item Name and Actions -->
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <div>
                    <h3 style="margin: 0; color: #374151; font-size: 1.1rem; font-weight: 600;">
                        {{if .ItemName}}{{.ItemName}}{{else if .BricklinkID}}{{.BricklinkID}}{{else}}Unknown Minifig{{end}}
                    </h3>
                    {{if .ReferenceID}}
                        <div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.25rem;">
                            üóÉÔ∏è {{.ReferenceID}}
                        </div>
                    {{end}}
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                            hx-get="/partial-minifigs-lists/{{.PartialMinifigListID}}/partial-minifig/{{.ID}}/edit" 
                            hx-target="#modal-container" 
                            hx-swap="innerHTML">
                        Edit
                    </button>
                    <button class="btn" style="background: #dc2626; padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                            hx-delete="/partial-minifigs-lists/{{.PartialMinifigListID}}/partial-minifig/{{.ID}}" 
                            hx-target="#list-items" 
                            hx-swap="outerHTML"
                            hx-confirm="Are you sure you want to delete this item?">
                        Delete
                    </button>
                </div>
            </div>
            
            <!-- Details Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <!-- Condition -->
                <div>
                    <div style="font-size: 0.75rem; color: #6b7280; font-weight: 500; margin-bottom: 0.25rem;">
                        CONDITION
                    </div>
                    <div style="font-size: 0.875rem; color: #374151;">
                        {{if .Condition}}
                            {{if eq .Condition "N"}}
                                <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">New</span>
                            {{else if eq .Condition "U"}}
                                <span style="background: #fed7aa; color: #9a3412; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Used</span>
                            {{else}}
                                {{.Condition}}
                            {{end}}
                        {{else}}
                            <span style="color: #9ca3af;">Not specified</span>
                        {{end}}
                    </div>
                </div>
                
                <!-- Created Date -->
                <div>
                    <div style="font-size: 0.75rem; color: #6b7280; font-weight: 500; margin-bottom: 0.25rem;">
                        ADDED
                    </div>
                    <div style="font-size: 0.875rem; color: #374151;">
                        {{.CreatedAt.Format "Jan 2, 2006"}}
                    </div>
                </div>
            </div>
            
            <!-- Notes -->
            {{if .Notes}}
                <div style="margin-bottom: 1rem;">
                    <div style="font-size: 0.75rem; color: #6b7280; font-weight: 500; margin-bottom: 0.25rem;">
                        NOTES
                    </div>
                    <div style="font-size: 0.875rem; color: #374151; background: #f8f9fa; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #3b82f6;">
                        {{.Notes}}
                    </div>
                </div>
            {{end}}
            
            <!-- Parts Summary -->
            <div style="margin-top: auto;">
                <div style="font-size: 0.75rem; color: #6b7280; font-weight: 500; margin-bottom: 0.25rem;">
                    PARTS PROGRESS
                </div>
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    {{if .Parts}}
                        {{$totalParts := 0}}
                        {{$totalNeeded := 0}}
                        {{$totalCollected := 0}}
                        {{range .Parts}}
                            {{$totalParts = plus $totalParts 1}}
                            {{$totalNeeded = plus $totalNeeded .QuantityNeeded}}
                            {{$totalCollected = plus $totalCollected .QuantityCollected}}
                        {{end}}
                        {{$percentage := 0}}
                        {{if gt $totalNeeded 0}}
                            {{$percentage = div (mul $totalCollected 100) $totalNeeded}}
                        {{end}}
                        
                        <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                            <div style="font-size: 0.875rem; color: #374151; font-weight: 500;">
                                {{$totalCollected}}/{{$totalNeeded}} pieces ({{$percentage}}%)
                            </div>
                            <div style="font-size: 0.75rem; color: #6b7280;">
                                {{$totalParts}} unique parts
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div style="flex: 1; max-width: 100px;">
                            <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: {{if eq $percentage 100}}#10b981{{else}}#3b82f6{{end}}; height: 100%; width: {{$percentage}}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        
                        <button style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; color: #6b7280; cursor: pointer;"
                                onclick="togglePartsForMinifig({{.ID}})">
                            <span id="parts-toggle-{{.ID}}">Show Parts</span>
                        </button>
                    {{else}}
                        <div style="font-size: 0.875rem; color: #9ca3af;">
                            Parts not loaded
                        </div>
                    {{end}}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Expandable Parts List -->
    {{if .Parts}}
        <div id="parts-list-{{.ID}}" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
            <div style="font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.75rem;">
                Required Parts ({{len .Parts}})
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.75rem;">
                {{range .Parts}}
                    <div style="background: #f8f9fa; padding: 0.75rem; border-radius: 6px; border: 1px solid #e5e7eb; {{if eq .QuantityCollected .QuantityNeeded}}border-color: #10b981;{{end}}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <div style="font-size: 0.8rem; font-weight: 500; color: #374151;">
                                {{if .PartName}}{{.PartName}}{{else if .BricklinkID}}{{.BricklinkID}}{{else}}Part {{.ItemID}}{{end}}
                            </div>
                            <div style="font-size: 0.75rem; color: #374151; font-weight: 600;">
                                {{.QuantityCollected}}/{{.QuantityNeeded}}
                            </div>
                        </div>
                        
                        <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem;">
                            {{if .BricklinkID}}ID: {{.BricklinkID}}{{else}}Item: {{.ItemID}}{{end}}
                            {{if .ColorID}} | Color: {{.ColorID}}{{end}}
                            {{if .Condition}} | {{if eq .Condition "N"}}New{{else if eq .Condition "U"}}Used{{else}}{{.Condition}}{{end}}{{end}}
                        </div>
                        
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <!-- Progress for this part -->
                            <div style="flex: 1; margin-right: 0.5rem;">
                                {{$partPercentage := 0}}
                                {{if gt .QuantityNeeded 0}}
                                    {{$partPercentage = div (mul .QuantityCollected 100) .QuantityNeeded}}
                                {{end}}
                                <div style="background: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden;">
                                    <div style="background: {{if eq .QuantityCollected .QuantityNeeded}}#10b981{{else}}#3b82f6{{end}}; height: 100%; width: {{$partPercentage}}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            
                            {{if eq .QuantityCollected .QuantityNeeded}}
                                <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">‚úì Complete</span>
                            {{else}}
                                <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem;">{{$partPercentage}}%</span>
                            {{end}}
                        </div>
                    </div>
                {{end}}
            </div>
        </div>
    {{end}}
</div>

{{if .BricklinkID}}
<script>
// Auto-load minifig picture when card is rendered
(function() {
    const minifigId = '{{.BricklinkID}}';
    const cardId = '{{.ID}}';
    
    console.log('Initializing picture loading for:', {minifigId, cardId});
    
    if (minifigId && cardId) {
        // Use a small delay to ensure DOM is ready
        setTimeout(function() {
            loadMinifigPictureForCard(minifigId, cardId);
        }, 100);
    }
})();

function loadMinifigPictureForCard(minifigId, cardId) {
    console.log('Loading picture for card:', cardId, 'minifig:', minifigId);
    
    const pictureContainer = document.getElementById('minifig-picture-' + cardId);
    if (!pictureContainer) {
        console.error('Picture container not found for card:', cardId);
        return;
    }
    
    fetch('/partial-minifigs-lists/minifig-picture', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'bricklink_id=' + encodeURIComponent(minifigId)
    })
    .then(response => {
        console.log('Picture API response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Picture API response for card:', data);
        
        if (data && data.meta && data.meta.code === 200 && data.data) {
            const firstImage = data.data;
            const imageUrl = firstImage.thumbnail_url || firstImage.url;
            if (imageUrl) {
                pictureContainer.innerHTML = '<img src="' + imageUrl + '" alt="Minifig ' + minifigId + '" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px;"><div style="position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.7); color: white; padding: 2px 4px; border-radius: 4px; font-size: 0.6rem;">' + minifigId + '</div>';
                pictureContainer.style.display = 'flex';
                pictureContainer.style.alignItems = 'center';
                pictureContainer.style.justifyContent = 'center';
                pictureContainer.style.position = 'relative';
            }
        } else {
            console.log('Picture API failed for card:', cardId, data && data.meta ? data.meta.message : 'Unknown error');
        }
    })
    .catch(error => {
        console.error('Error loading picture for card:', cardId, error);
    });
}

function togglePartsForMinifig(minifigId) {
    const partsList = document.getElementById('parts-list-' + minifigId);
    const toggleText = document.getElementById('parts-toggle-' + minifigId);
    
    if (partsList.style.display === 'none') {
        partsList.style.display = 'block';
        toggleText.textContent = 'Hide Parts';
    } else {
        partsList.style.display = 'none';
        toggleText.textContent = 'Show Parts';
    }
}
</script>
{{end}}
{{ end }}