{{define "minifig-details-modal"}}
<div class="modal-overlay" id="minifig-details-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;" hx-on:click="if(event.target === this) closeMinifigDetailsModal()">
    <div class="modal" style="background: white; border-radius: 8px; padding: 2rem; max-width: 500px; width: 90vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);">
        <h2 style="margin: 0 0 1.5rem 0; color: #374151; text-align: center;">Minifig Details</h2>
        
        <form id="minifig-details-form" onsubmit="return submitMinifigDetails(event)">
            <div style="margin-bottom: 1rem;">
                <label for="reference_id" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">
                    Reference ID / Location:
                </label>
                <input type="text" 
                       id="reference_id" 
                       name="reference_id"
                       placeholder="e.g., Box A, Shelf 2, etc." 
                       style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem;">
                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                    Optional: Where you store or found this minifig
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <label for="condition" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">
                    Condition you're trying to collect:
                </label>
                <select id="condition" 
                        name="condition"
                        style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; background: white;">
                    <option value="">Select condition...</option>
                    <option value="N">New</option>
                    <option value="U">Used</option>
                </select>
                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                    What condition are you trying to collect for this minifig?
                </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label for="notes" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">
                    Notes:
                </label>
                <textarea id="notes" 
                          name="notes"
                          rows="3"
                          placeholder="Any notes about this minifig..." 
                          style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.875rem; resize: vertical;"></textarea>
                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                    Optional: Any notes or comments about this minifig
                </div>
            </div>

            <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                <button type="button" 
                        onclick="closeMinifigDetailsModal()"
                        style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer; transition: background-color 0.2s;"
                        onmouseover="this.style.backgroundColor='#4b5563'"
                        onmouseout="this.style.backgroundColor='#6b7280'">
                    Cancel
                </button>
                <button type="submit"
                        style="background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer; transition: background-color 0.2s;"
                        onmouseover="this.style.backgroundColor='#2563eb'"
                        onmouseout="this.style.backgroundColor='#3b82f6'">
                    Add Minifig and Parts
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Store the current minifig data for when the modal is submitted
window.currentMinifigData = window.currentMinifigData || {};

function closeMinifigDetailsModal() {
    const overlay = document.getElementById('minifig-details-overlay');
    if (overlay) {
        overlay.remove();
    }
}

function submitMinifigDetails(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // Get the stored minifig data
    const minifigData = window.currentMinifigData;
    if (!minifigData || !minifigData.itemId || !minifigData.selectedParts) {
        alert('Missing minifig data. Please try again.');
        return false;
    }
    
    // Collect form data
    const referenceId = formData.get('reference_id') || '';
    const condition = formData.get('condition') || '';
    const notes = formData.get('notes') || '';
    
    // Set condition for each part if a global condition was selected
    if (condition) {
        minifigData.selectedParts.forEach(part => {
            part.condition = condition;
        });
    }
    
    console.log('Submitting minifig with details:', {
        itemId: minifigData.itemId,
        referenceId: referenceId,
        condition: condition,
        notes: notes,
        selectedParts: minifigData.selectedParts
    });
    
    // Close the modal
    closeMinifigDetailsModal();
    
    // Disable the add button while processing
    const addButton = document.getElementById('add-minifig-' + minifigData.itemId);
    if (addButton) {
        addButton.disabled = true;
        addButton.textContent = 'Adding...';
    }
    
    // Make API call to add minifig with parts and details
    fetch('/partial-minifigs-lists/add-minifig-with-parts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'list_id=' + encodeURIComponent(minifigData.listId) +
              '&minifig_id=' + encodeURIComponent(minifigData.itemId) +
              '&reference_id=' + encodeURIComponent(referenceId) +
              '&condition=' + encodeURIComponent(condition) +
              '&notes=' + encodeURIComponent(notes) +
              '&selected_parts=' + encodeURIComponent(JSON.stringify(minifigData.selectedParts))
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.text();
    })
    .then(html => {
        console.log('Successfully added minifig and parts with details');
        
        // Update the list items section with the returned HTML
        const listItemsSection = document.querySelector('[data-section="list-items"]');
        if (listItemsSection) {
            listItemsSection.innerHTML = html;
        }
        
        // Close any remaining modals
        const modalContainer = document.getElementById('modal-container');
        if (modalContainer) {
            modalContainer.innerHTML = '';
        }
        
        // Show success message
        if (typeof showNotification === 'function') {
            showNotification('Successfully added ' + minifigData.itemId + ' with ' + minifigData.selectedParts.length + ' parts to your list!', 'success');
        } else {
            alert('Successfully added ' + minifigData.itemId + ' with ' + minifigData.selectedParts.length + ' parts to your list!');
        }
    })
    .catch(error => {
        console.error('Error adding minifig and parts:', error);
        if (typeof showErrorMessage === 'function') {
            showErrorMessage(minifigData.itemId, 'Failed to add minifig and parts: ' + error.message);
        } else {
            alert('Failed to add minifig and parts: ' + error.message);
        }
    })
    .finally(() => {
        // Re-enable the button
        if (addButton) {
            addButton.disabled = false;
            addButton.textContent = 'Add Minifig and Parts';
        }
    });
    
    return false;
}
</script>
{{end}}